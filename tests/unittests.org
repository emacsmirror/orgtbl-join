#+TITLE: Unit Tests & Examples for Orgtbl Join
Copyright (C) 2014-2025  Thierry Banel

orgtbl-join is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

orgtbl-join is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

* How to run?
Running all tests should not change anything to this page.

Run this script to complete all the unit tests in a disposable
buffer. When done, the buffer and the original, untouched
~unittests.org~, are compared, stopping at the first difference.

#+begin_src elisp :results none
(delete-other-windows)
(goto-char (point-min))
(org-cycle '(64))
(split-window-right)

;; Make a new buffer and fill it with the content of unittests.org

(let ((f (buffer-file-name)))
  (switch-to-buffer "disposable-unittest.org")
  (erase-buffer)
  (insert-file f))

(org-mode)
(org-cycle '(64))

;; Clean results from prior tests
(save-excursion
  (goto-char (point-min))
  (replace-regexp
   (rx (group bol "#+BEGIN" (* not-newline) "\n")
       (* "|" (* not-newline) "\n"))
   "\\1"))

;; Compute all pull-mode tests
(let ((org-calc-default-modes
       (cons 'calc-float-format (cons '(float 12) org-calc-default-modes))))
  (org-update-all-dblocks))

;; Compute all push-mode tests
(let ((org-calc-default-modes
       (cons 'calc-float-format (cons '(float 12) org-calc-default-modes))))
  (org-table-map-tables
    (lambda ()
      (when (save-excursion
	      (forward-line -1)
	      (looking-at-p (rx (or "#+begin" "#+orgtbl"))))
	(orgtbl-send-table 'maybe)))))

;; Compare the disposable buffer with the reference unittests.org
(goto-char (point-min))
(compare-windows nil)
  #+end_src

* In-place mode

** Nutritional reference table with header

There are multiple "eggplant" entries on purpose.
They will all get added to the master table when joining.

The header extends on 3 lines. All 3 lines will be concatenated to the
master table header, provided the master table header has at least 3
lines. The excess lines will be ignored.

#+tblname: nut_with_header

  # ignore intermediate stuff between "name:" and actual table
  # ignore blank lines

|------+----------+-------+-------+---------|
| Carb | type     | Fiber | Sugar | Protein |
| ohyd |          |       |       |         |
| rate |          |       |       |         |
|------+----------+-------+-------+---------|
|  8.6 | eggplant |   2.5 |   3.2 |     0.8 |
|  8.7 | eggplant |   2.6 |   3.3 |     0.9 |
|  3.4 | tomatoe  |   0.6 |   2.1 |     0.8 |
|  9.0 | onion    |   1.3 |   4.4 |     1.3 |
| 18.3 | egg      |     0 |  18.3 |    31.9 |
| 16.0 | rice     |   0.2 |     0 |     1.5 |
| 16.0 | bread    |   0.7 |   0.7 |     3.3 |
| 17.6 | orange   |   3.1 |  11.9 |     1.3 |
| 18.5 | banana   |   2.1 |   9.9 |     0.9 |
|  1.4 | tofu     |   0.7 |   0.5 |     6.6 |
|  7.2 | nut      |   2.6 |   1.3 |     4.9 |
| 21.3 | corn     |   4.7 |   1.8 |     2.8 |
|  8.5 | eggplant |     ? |     ? |       ? |
|      |          |       |       |         |

** Nutritional reference table without header

#+tblname: nut_no_header
|  8.6 | eggplant | 2.5 |  3.2 |  0.8 |
|  8.7 | eggplant | 2.6 |  3.3 |  0.9 |
|  3.4 | tomatoe  | 0.6 |  2.1 |  0.8 |
|  9.0 | onion    | 1.3 |  4.4 |  1.3 |
| 18.3 | egg      |   0 | 18.3 | 31.9 |
| 16.0 | rice     | 0.2 |    0 |  1.5 |
| 16.0 | bread    | 0.7 |  0.7 |  3.3 |
| 17.6 | orange   | 3.1 | 11.9 |  1.3 |
| 18.5 | banana   | 2.1 |  9.9 |  0.9 |
|  1.4 | tofu     | 0.7 |  0.5 |  6.6 |
|  7.2 | nut      | 2.6 |  1.3 |  4.9 |
| 21.3 | corn     | 4.7 |  1.8 |  2.8 |
|  8.5 | eggplant |   ? |    ? |    ? |
|      |          |     |      |      |

** Play with M-x orgtbl-join

Those recipes should to be augmented interactively with nutritional facts

The master tables have a formula on the last column, which will be
preserved after joining.

With header.
- Put the cursor on the "type" column
- type
  : M-x orgtbl-join
- answer
  : nut_with_header
  : type

| quty | type     | units |  mul |
|------+----------+-------+------|
|   70 | onion    |     5 |  350 |
|  120 | tomatoe  |     8 |  960 |
|  300 | eggplant |     2 |  600 |
|------+----------+-------+------|
|  100 | tofu     |     1 |  100 |
|  250 | corn     |    15 | 3750 |
|   90 | tomatoe  |     5 |  450 |
|------+----------+-------+------|
|   80 | amarante |     1 |   80 |
#+TBLFM: $4=$1*$3

Without header.
- Put the cursor on the second column
- type
  : M-x orgtbl-join
- answer
  : nut_with_header
  : type

|  70 | onion    |  5 |  350 |
| 120 | tomatoe  |  8 |  960 |
| 300 | eggplant |  2 |  600 |
| 100 | tofu     |  1 |  100 |
| 250 | corn     | 15 | 3750 |
|  90 | tomatoe  |  5 |  450 |
|  80 | amarante |  1 |   80 |
#+TBLFM: $4=$1*$3

* PULL mode

** Master table with oversized header

#+tblname: meal_with_header
| product   |   quty |
| common    |     in |
| name      | gramms |
| (english) |        |
|-----------+--------|
| onion     |     70 |
| unknown   |    999 |
| tomatoe   |    120 |
| eggplant  |    300 |
| corn      |    250 |

** Master table without header

#+tblname: meal_no_header
| onion     |  70 |
| not known | 999 |
| tomatoe   | 120 |
| eggplant  | 300 |
| corn      | 250 |

** Join header+header

#+BEGIN: join :mas-table meal_with_header :mas-column $1 :ref-table nut_with_header :ref-column $2
| product   |   quty | Carb | Fiber | Sugar | Protein |
| common    |     in | ohyd |       |       |         |
| name      | gramms | rate |       |       |         |
| (english) |        |
|-----------+--------+------+-------+-------+---------|
| onion     |     70 |  9.0 |   1.3 |   4.4 |     1.3 |
| unknown   |    999 |
| tomatoe   |    120 |  3.4 |   0.6 |   2.1 |     0.8 |
| eggplant  |    300 |  8.6 |   2.5 |   3.2 |     0.8 |
| eggplant  |    300 |  8.7 |   2.6 |   3.3 |     0.9 |
| eggplant  |    300 |  8.5 |     ? |     ? |       ? |
| corn      |    250 | 21.3 |   4.7 |   1.8 |     2.8 |
#+END:

** join header+bare

#+BEGIN: join :mas-table "meal_with_header" :mas-column "product" :ref-table "nut_no_header" :ref-column "$2"
| product   |   quty |
| common    |     in |
| name      | gramms |
| (english) |        |
|-----------+--------+------+-----+-----+-----|
| onion     |     70 |  9.0 | 1.3 | 4.4 | 1.3 |
| unknown   |    999 |
| tomatoe   |    120 |  3.4 | 0.6 | 2.1 | 0.8 |
| eggplant  |    300 |  8.6 | 2.5 | 3.2 | 0.8 |
| eggplant  |    300 |  8.7 | 2.6 | 3.3 | 0.9 |
| eggplant  |    300 |  8.5 |   ? |   ? |   ? |
| corn      |    250 | 21.3 | 4.7 | 1.8 | 2.8 |
#+END:

** join bare+header

#+BEGIN: join :mas-table meal_no_header :mas-column $1 :ref-table nut_with_header :ref-column type
| onion     |  70 |  9.0 | 1.3 | 4.4 | 1.3 |
| not known | 999 |
| tomatoe   | 120 |  3.4 | 0.6 | 2.1 | 0.8 |
| eggplant  | 300 |  8.6 | 2.5 | 3.2 | 0.8 |
| eggplant  | 300 |  8.7 | 2.6 | 3.3 | 0.9 |
| eggplant  | 300 |  8.5 |   ? |   ? |   ? |
| corn      | 250 | 21.3 | 4.7 | 1.8 | 2.8 |
#+END:

** join bare+bare

#+BEGIN: join :mas-table meal_no_header :mas-column $1 :ref-table nut_no_header :ref-column $2
| onion     |  70 |  9.0 | 1.3 | 4.4 | 1.3 |
| not known | 999 |
| tomatoe   | 120 |  3.4 | 0.6 | 2.1 | 0.8 |
| eggplant  | 300 |  8.6 | 2.5 | 3.2 | 0.8 |
| eggplant  | 300 |  8.7 | 2.6 | 3.3 | 0.9 |
| eggplant  | 300 |  8.5 |   ? |   ? |   ? |
| corn      | 250 | 21.3 | 4.7 | 1.8 | 2.8 |
#+END:

** surviving name and formula

#+BEGIN: join :mas-table meal_with_header :mas-column $1 :ref-table nut_with_header :ref-column $2 :formula "@1$7=totcarb"
#+name: enriched
#+caption: the enriched table
#+attr_center: yes
| product   |   quty | Carb | Fiber | Sugar | Protein | totcarb |
| common    |     in | ohyd |       |       |         |         |
| name      | gramms | rate |       |       |         |         |
| (english) |        |      |       |       |         |         |
|-----------+--------+------+-------+-------+---------+---------|
| onion     |     70 |  9.0 |   1.3 |   4.4 |     1.3 |    630. |
| unknown   |    999 |      |       |       |         |       0 |
| tomatoe   |    120 |  3.4 |   0.6 |   2.1 |     0.8 |    408. |
| eggplant  |    300 |  8.6 |   2.5 |   3.2 |     0.8 |   2580. |
| eggplant  |    300 |  8.7 |   2.6 |   3.3 |     0.9 |   2610. |
| eggplant  |    300 |  8.5 |     ? |     ? |       ? |   2550. |
| corn      |    250 | 21.3 |   4.7 |   1.8 |     2.8 |   5325. |
#+TBLFM: $7=$2*$3::@1$7=totcarb
#+END:

* PUSH mode

** Push a master table with header

1st reference table has a larger header
2nd reference table has no header

#+ORGTBL: SEND joined1 orgtbl-to-joined-table :ref-table nut_with_header :mas-column product :ref-column type
#+ORGTBL: SEND joined2 orgtbl-to-joined-table :ref-table "nut_no_header" :mas-column "$1"    :ref-column $2
| product       | quty |
| (yes)         |  (g) |
|---------------+------|
| onion         |   70 |
| not specified |  999 |
| tomatoe       |  120 |
| eggplant      |  300 |
| corn          |  250 |

#+BEGIN RECEIVE ORGTBL joined1
| product       | quty | Carb | Fiber | Sugar | Protein |
| (yes)         |  (g) | ohyd |       |       |         |
|---------------+------+------+-------+-------+---------|
| onion         |   70 |  9.0 |   1.3 |   4.4 |     1.3 |
| not specified |  999 |
| tomatoe       |  120 |  3.4 |   0.6 |   2.1 |     0.8 |
| eggplant      |  300 |  8.6 |   2.5 |   3.2 |     0.8 |
| eggplant      |  300 |  8.7 |   2.6 |   3.3 |     0.9 |
| eggplant      |  300 |  8.5 |     ? |     ? |       ? |
| corn          |  250 | 21.3 |   4.7 |   1.8 |     2.8 |
#+END RECEIVE ORGTBL joined1

#+BEGIN RECEIVE ORGTBL joined2
| product       | quty |
| (yes)         |  (g) |
|---------------+------+------+-----+-----+-----|
| onion         |   70 |  9.0 | 1.3 | 4.4 | 1.3 |
| not specified |  999 |
| tomatoe       |  120 |  3.4 | 0.6 | 2.1 | 0.8 |
| eggplant      |  300 |  8.6 | 2.5 | 3.2 | 0.8 |
| eggplant      |  300 |  8.7 | 2.6 | 3.3 | 0.9 |
| eggplant      |  300 |  8.5 |   ? |   ? |   ? |
| corn          |  250 | 21.3 | 4.7 | 1.8 | 2.8 |
#+END RECEIVE ORGTBL joined2

** Push a master table with not header

1st reference table has a larger header
2nd reference table has no header

#+ORGTBL: SEND joined3 orgtbl-to-joined-table :ref-table nut_with_header :mas-column "$1" :ref-column type
#+ORGTBL: SEND joined4 orgtbl-to-joined-table :ref-table "nut_no_header" :mas-column $1  :ref-column $2
| onion         |  70 |
| not specified | 999 |
| tomatoe       | 120 |
| eggplant      | 300 |
| corn          | 250 |

#+BEGIN RECEIVE ORGTBL joined3
| onion         |  70 |  9.0 | 1.3 | 4.4 | 1.3 |
| not specified | 999 |
| tomatoe       | 120 |  3.4 | 0.6 | 2.1 | 0.8 |
| eggplant      | 300 |  8.6 | 2.5 | 3.2 | 0.8 |
| eggplant      | 300 |  8.7 | 2.6 | 3.3 | 0.9 |
| eggplant      | 300 |  8.5 |   ? |   ? |   ? |
| corn          | 250 | 21.3 | 4.7 | 1.8 | 2.8 |
#+END RECEIVE ORGTBL joined3

#+BEGIN RECEIVE ORGTBL joined4
| onion         |  70 |  9.0 | 1.3 | 4.4 | 1.3 |
| not specified | 999 |
| tomatoe       | 120 |  3.4 | 0.6 | 2.1 | 0.8 |
| eggplant      | 300 |  8.6 | 2.5 | 3.2 | 0.8 |
| eggplant      | 300 |  8.7 | 2.6 | 3.3 | 0.9 |
| eggplant      | 300 |  8.5 |   ? |   ? |   ? |
| corn          | 250 | 21.3 | 4.7 | 1.8 | 2.8 |
#+END RECEIVE ORGTBL joined4

* Cartesian product

What happens when the master and the reference table are the same
table?  A so-called cartesian product (named after the mathematician
René Descartes) is created.  Every possible combination of rows is
created.

** Simple auto-join in pull-mode

The table is joined with itself, creating a cartesian product.  The
resulting table size is the square of the original table size (7*7 =
49).

#+tblname: auto
| t | n |
|---+---|
| a | 1 |
| a | 2 |
| a | 3 |
| a | 4 |
| a | 5 |
| a | 6 |
| a | 7 |

#+BEGIN: join :mas-table auto :mas-column t :ref-table auto :ref-column "t"
| t | n | n |
|---+---+---|
| a | 1 | 1 |
| a | 1 | 2 |
| a | 1 | 3 |
| a | 1 | 4 |
| a | 1 | 5 |
| a | 1 | 6 |
| a | 1 | 7 |
| a | 2 | 1 |
| a | 2 | 2 |
| a | 2 | 3 |
| a | 2 | 4 |
| a | 2 | 5 |
| a | 2 | 6 |
| a | 2 | 7 |
| a | 3 | 1 |
| a | 3 | 2 |
| a | 3 | 3 |
| a | 3 | 4 |
| a | 3 | 5 |
| a | 3 | 6 |
| a | 3 | 7 |
| a | 4 | 1 |
| a | 4 | 2 |
| a | 4 | 3 |
| a | 4 | 4 |
| a | 4 | 5 |
| a | 4 | 6 |
| a | 4 | 7 |
| a | 5 | 1 |
| a | 5 | 2 |
| a | 5 | 3 |
| a | 5 | 4 |
| a | 5 | 5 |
| a | 5 | 6 |
| a | 5 | 7 |
| a | 6 | 1 |
| a | 6 | 2 |
| a | 6 | 3 |
| a | 6 | 4 |
| a | 6 | 5 |
| a | 6 | 6 |
| a | 6 | 7 |
| a | 7 | 1 |
| a | 7 | 2 |
| a | 7 | 3 |
| a | 7 | 4 |
| a | 7 | 5 |
| a | 7 | 6 |
| a | 7 | 7 |
#+END:

** Two sub-cartesian-products in push mode

Because the table has two keys (a & b), two completely unrelated
cartesian products are created, each the square size of the source
(3^2 + 2^2 = 13).

#+tblname: buto
#+ORGTBL: SEND buto2 orgtbl-to-joined-table :ref-table buto :mas-column "t" :ref-column t
| t | n |
|---+---|
| a | 1 |
| a | 2 |
| a | 3 |
| b | 4 |
| b | 5 |

#+BEGIN RECEIVE ORGTBL buto2
| t | n | n |
|---+---+---|
| a | 1 | 1 |
| a | 1 | 2 |
| a | 1 | 3 |
| a | 2 | 1 |
| a | 2 | 2 |
| a | 2 | 3 |
| a | 3 | 1 |
| a | 3 | 2 |
| a | 3 | 3 |
| b | 4 | 4 |
| b | 4 | 5 |
| b | 5 | 4 |
| b | 5 | 5 |
#+END RECEIVE ORGTBL buto2

* Malformed tables
Some columns are missing in some rows
This is on purpose
orgaggregate should tolerate such tables
Missing cells are handled as though they were empty

#+tblname: nut_malformed
| type     | Fiber | Sugar |      | Carb |
|----------+-------+-------+------+------|
| eggplant |   2.5 |   3.2 |  0.8 |  8.6 |
| tomatoe  |   0.6 |   2.1 |  0.8 |  3.4 |
| onion    |   1.3 |   4.4 |  1.3 |  9.0 |
| egg      |     0 |  18.3 | 31.9 | 18.3 |
| rice     |   0.2 |     0 |  1.5 | 16.0 |
| bread    |   0.7 |   0.7 |  3.3 | 16.0 |
| orange   |   3.1 |  11.9 |  1.3 | 17.6 |
| banana   |   2.1 |   9.9 |  0.9 | 18.5 |
| tofu     |  0.7
| nut      |   2.6 |   1.3 |  4.9 |  7.2 |
| corn     |   4.7 |   1.8 |  2.8 | 21.3 |

#+tblname: recipe_malformed
| type     | quty |
|----------+------|
| onion    |   70 |
| tomatoe  |
| eggplant |  300 |
| tofu     |  100 |

#+BEGIN: join :mas-table "recipe_malformed" :mas-column "type" :ref-table "nut_malformed" :ref-column "type"
| type     | quty | Fiber | Sugar |     | Carb |
|----------+------+-------+-------+-----+------|
| onion    |   70 |   1.3 |   4.4 | 1.3 |  9.0 |
| tomatoe  |      |   0.6 |   2.1 | 0.8 |  3.4 |
| eggplant |  300 |   2.5 |   3.2 | 0.8 |  8.6 |
| tofu     |  100 |   0.7 |
#+END:
* :full options

#+BEGIN: join :mas-table meal_with_header :mas-column product :ref-table nut_with_header :ref-column type
| product   |   quty | Carb | Fiber | Sugar | Protein |
| common    |     in | ohyd |       |       |         |
| name      | gramms | rate |       |       |         |
| (english) |        |
|-----------+--------+------+-------+-------+---------|
| onion     |     70 |  9.0 |   1.3 |   4.4 |     1.3 |
| unknown   |    999 |
| tomatoe   |    120 |  3.4 |   0.6 |   2.1 |     0.8 |
| eggplant  |    300 |  8.6 |   2.5 |   3.2 |     0.8 |
| eggplant  |    300 |  8.7 |   2.6 |   3.3 |     0.9 |
| eggplant  |    300 |  8.5 |     ? |     ? |       ? |
| corn      |    250 | 21.3 |   4.7 |   1.8 |     2.8 |
#+END:

#+BEGIN: join :mas-table meal_with_header :mas-column product :ref-table nut_with_header :ref-column type :full mas
| product   |   quty | Carb | Fiber | Sugar | Protein |
| common    |     in | ohyd |       |       |         |
| name      | gramms | rate |       |       |         |
| (english) |        |
|-----------+--------+------+-------+-------+---------|
| onion     |     70 |  9.0 |   1.3 |   4.4 |     1.3 |
| unknown   |    999 |
| tomatoe   |    120 |  3.4 |   0.6 |   2.1 |     0.8 |
| eggplant  |    300 |  8.6 |   2.5 |   3.2 |     0.8 |
| eggplant  |    300 |  8.7 |   2.6 |   3.3 |     0.9 |
| eggplant  |    300 |  8.5 |     ? |     ? |       ? |
| corn      |    250 | 21.3 |   4.7 |   1.8 |     2.8 |
#+END:

#+BEGIN: join :mas-table meal_with_header :mas-column product :full ref :ref-table nut_with_header :ref-column type
| product   |   quty | Carb | Fiber | Sugar | Protein |
| common    |     in | ohyd |       |       |         |
| name      | gramms | rate |       |       |         |
| (english) |        |
|-----------+--------+------+-------+-------+---------|
| onion     |     70 |  9.0 |   1.3 |   4.4 |     1.3 |
| tomatoe   |    120 |  3.4 |   0.6 |   2.1 |     0.8 |
| eggplant  |    300 |  8.6 |   2.5 |   3.2 |     0.8 |
| eggplant  |    300 |  8.7 |   2.6 |   3.3 |     0.9 |
| eggplant  |    300 |  8.5 |     ? |     ? |       ? |
| corn      |    250 | 21.3 |   4.7 |   1.8 |     2.8 |
|-----------+--------+------+-------+-------+---------|
| egg       |        | 18.3 |     0 |  18.3 |    31.9 |
| rice      |        | 16.0 |   0.2 |     0 |     1.5 |
| bread     |        | 16.0 |   0.7 |   0.7 |     3.3 |
| orange    |        | 17.6 |   3.1 |  11.9 |     1.3 |
| banana    |        | 18.5 |   2.1 |   9.9 |     0.9 |
| tofu      |        |  1.4 |   0.7 |   0.5 |     6.6 |
| nut       |        |  7.2 |   2.6 |   1.3 |     4.9 |
|           |        |      |       |       |         |
#+END:

#+BEGIN: join :full none :mas-table meal_with_header :mas-column product :ref-table nut_with_header :ref-column type
| product   |   quty | Carb | Fiber | Sugar | Protein |
| common    |     in | ohyd |       |       |         |
| name      | gramms | rate |       |       |         |
| (english) |        |
|-----------+--------+------+-------+-------+---------|
| onion     |     70 |  9.0 |   1.3 |   4.4 |     1.3 |
| tomatoe   |    120 |  3.4 |   0.6 |   2.1 |     0.8 |
| eggplant  |    300 |  8.6 |   2.5 |   3.2 |     0.8 |
| eggplant  |    300 |  8.7 |   2.6 |   3.3 |     0.9 |
| eggplant  |    300 |  8.5 |     ? |     ? |       ? |
| corn      |    250 | 21.3 |   4.7 |   1.8 |     2.8 |
#+END:

#+BEGIN: join :mas-table meal_with_header :full ref+mas :mas-column product :ref-table nut_with_header :ref-column type
| product   |   quty | Carb | Fiber | Sugar | Protein |
| common    |     in | ohyd |       |       |         |
| name      | gramms | rate |       |       |         |
| (english) |        |
|-----------+--------+------+-------+-------+---------|
| onion     |     70 |  9.0 |   1.3 |   4.4 |     1.3 |
| unknown   |    999 |
| tomatoe   |    120 |  3.4 |   0.6 |   2.1 |     0.8 |
| eggplant  |    300 |  8.6 |   2.5 |   3.2 |     0.8 |
| eggplant  |    300 |  8.7 |   2.6 |   3.3 |     0.9 |
| eggplant  |    300 |  8.5 |     ? |     ? |       ? |
| corn      |    250 | 21.3 |   4.7 |   1.8 |     2.8 |
|-----------+--------+------+-------+-------+---------|
| egg       |        | 18.3 |     0 |  18.3 |    31.9 |
| rice      |        | 16.0 |   0.2 |     0 |     1.5 |
| bread     |        | 16.0 |   0.7 |   0.7 |     3.3 |
| orange    |        | 17.6 |   3.1 |  11.9 |     1.3 |
| banana    |        | 18.5 |   2.1 |   9.9 |     0.9 |
| tofu      |        |  1.4 |   0.7 |   0.5 |     6.6 |
| nut       |        |  7.2 |   2.6 |   1.3 |     4.9 |
|           |        |      |       |       |         |
#+END:

* :cols specification

#+BEGIN: join :cols (Fiber quty product $2) :mas-table meal_with_header :mas-column product :ref-table nut_with_header :ref-column type
| Fiber |   quty | product   |   quty |
|       |     in | common    |     in |
|       | gramms | name      | gramms |
|       |        | (english) |        |
|-------+--------+-----------+--------|
|   1.3 |     70 | onion     |     70 |
|       |    999 | unknown   |    999 |
|   0.6 |    120 | tomatoe   |    120 |
|   2.5 |    300 | eggplant  |    300 |
|   2.6 |    300 | eggplant  |    300 |
|     ? |    300 | eggplant  |    300 |
|   4.7 |    250 | corn      |    250 |
#+END:

#+BEGIN: join :cols "Sugar quty $1 $6 $0" :mas-table meal_with_header :mas-column product :ref-table nut_with_header :ref-column type :full mas
| Sugar |   quty | product   | Protein | product   |
|       |     in | common    |         | common    |
|       | gramms | name      |         | name      |
|       |        | (english) |         | (english) |
|-------+--------+-----------+---------+-----------|
|   4.4 |     70 | onion     |     1.3 | onion     |
|       |    999 | unknown   |         | unknown   |
|   2.1 |    120 | tomatoe   |     0.8 | tomatoe   |
|   3.2 |    300 | eggplant  |     0.8 | eggplant  |
|   3.3 |    300 | eggplant  |     0.9 | eggplant  |
|     ? |    300 | eggplant  |       ? | eggplant  |
|   1.8 |    250 | corn      |     2.8 | corn      |
#+END:

* Japanese characters
Japanese characters are wider than ASCII ones.
In mono-spaced fonts, they are often 2 times wider.

Not all fonts are equal. The Ubuntu one is not too bad, although not perfect:
: (set-face-font 'default "Ubuntu Mono")

#+name: 日本のテーブル
| 如何         | 量 |
|--------------+----|
| 急行電車     | 23 |
| 山に雪が降る | 21 |
| 鳥と花       | 34 |
| 急行電車     | 61 |
| 鳥と花       | 93 |
| 山に雪が降る | 48 |

#+name: 参照表
| 如何         | 色   |
|--------------+------|
| 急行電車     | 黄   |
| 山に雪が降る | 赤   |
| 鳥と花       | 青い |

#+BEGIN: join :mas-table "日本のテーブル" :mas-column "如何" :ref-table "参照表" :ref-column "如何" :full "mas" :cols "量 色 如何"
| 量 | 色   | 如何         |
|----+------+--------------|
| 23 | 黄   | 急行電車     |
| 21 | 赤   | 山に雪が降る |
| 34 | 青い | 鳥と花       |
| 61 | 黄   | 急行電車     |
| 93 | 青い | 鳥と花       |
| 48 | 赤   | 山に雪が降る |
#+END:

* Post process

A Babel post-process block which adds a last row to ~*this*~
#+name: add-ginger
#+begin_src elisp
(nconc *this* '((ginger 33 na na na na)))
#+end_src

Pull mode with a post-process babel block

#+BEGIN: join :mas-table meal_with_header :mas-column $1 :ref-table nut_with_header :ref-column $2 :post "add-ginger"
| product   |   quty | Carb | Fiber | Sugar | Protein |
| common    |     in | ohyd |       |       |         |
| name      | gramms | rate |       |       |         |
| (english) |        |
|-----------+--------+------+-------+-------+---------|
| onion     |     70 |  9.0 |   1.3 |   4.4 |     1.3 |
| unknown   |    999 |
| tomatoe   |    120 |  3.4 |   0.6 |   2.1 |     0.8 |
| eggplant  |    300 |  8.6 |   2.5 |   3.2 |     0.8 |
| eggplant  |    300 |  8.7 |   2.6 |   3.3 |     0.9 |
| eggplant  |    300 |  8.5 |     ? |     ? |       ? |
| corn      |    250 | 21.3 |   4.7 |   1.8 |     2.8 |
| ginger    |     33 |   na |    na |    na |      na |
#+END:

Push mode with a post-process Lisp expression

#+ORGTBL: SEND with-post orgtbl-to-joined-table :ref-table nut_with_header :mas-column product :ref-column type :post (nconc *this* '((grape 123 "?")))
| product       | quty |
|---------------+------|
| not specified |  999 |
| onion         |   70 |
| eggplant      |  300 |
| tomatoe       |  120 |

#+BEGIN RECEIVE ORGTBL with-post
| product       | quty | Carb | Fiber | Sugar | Protein |
|---------------+------+------+-------+-------+---------|
| not specified |  999 |
| onion         |   70 |  9.0 |   1.3 |   4.4 |     1.3 |
| eggplant      |  300 |  8.6 |   2.5 |   3.2 |     0.8 |
| eggplant      |  300 |  8.7 |   2.6 |   3.3 |     0.9 |
| eggplant      |  300 |  8.5 |     ? |     ? |       ? |
| tomatoe       |  120 |  3.4 |   0.6 |   2.1 |     0.8 |
| grape         |  123 |    ? |
#+END RECEIVE ORGTBL with-post

* Alignment cookies
What to do with cookies?
<> <l> <c> <r> <12> <l12> <c12> <r12>
They are not real data, rather metadata.

Cookies format a column. As columns appear mostly unchaged in the
joined table (except that some cells are filtered out and others are
duplicated), they probably benefit from the same formats as original
columns. Therefore:
- Cookies are handled as regular data
- Cookies in the headers are merged in the joined header

#+name: mas-with-cookies
| object   |   color |
| <l>      |         |
|          |     <r> |
|----------+---------|
| tree     |   green |
|          |    <12> |
| wall     |    grey |
| <r>      |     <c> |
| roof     |     red |
| orange   |  orange |
| banana   |  yellow |
| <15>     |         |
| panther  |    pink |
| Sun      |  yellow |
| <cookie> | <false> |
| cloud    |    grey |
| sky      |    blue |
|          |     <l> |

#+name: ref-with-cookies
|   color | code   |
|     <7> | <6>    |
|---------+--------|
|  yellow | #FF0   |
|     <r> |        |
|   white | #FFF   |
|     red | #F00   |
|     red | <l>    |
|    blue | #00F   |
|   green | #0F0   |
|   black | #000   |
|   <r12> |        |
|  orange | #F80   |
|    cyan | #0FF   |
| <color> | <#123> |
|  purple | #F0F   |
|    grey | #888   |
|  marine | #008   |
|    pink | #F88   |

#+BEGIN: join :mas-table "mas-with-cookies" :mas-column "color" :ref-table "ref-with-cookies" :ref-column "color" :full "mas"
| object   | color   | code |
| <l>      |         | <6>  |
|          | <r>     |
|----------+---------+------|
| tree     | green   | #0F0 |
|          | <12>    |
| wall     | grey    | #888 |
| <r>      | <c>     |
| roof     | red     | #F00 |
| roof     | red     | <l>  |
| orange   | orange  | #F80 |
| banana   | yellow  | #FF0 |
| <15>     |         |
| panther  | pink    | #F88 |
| Sun      | yellow  | #FF0 |
| <cookie> | <false> |
| cloud    | grey    | #888 |
| sky      | blue    | #00F |
|          | <l>     |
#+END:

* 1st data row is not the header
#+name: missing-header
| a | 12 | 33 |
| c | 13 | 12 |
| x | 14 | 12 |
| y | 15 | 45 |
| z |  7 |  7 |

#+name: ref-missing-header
| z | 15    |
| z | yes   |
| y | 13    |
| y | maybe |
| y | no    |
| x | yes   |
| c | no    |
| c | 71    |
| a | yes   |
| a | 32    |

this is a mistake ---------v
                           v
#+BEGIN: join :ref-column "15" :mas-table "missing-header" :mas-column "$1" :ref-table "ref-missing-header" :full "mas"

#+END:

If first data row is mistaken as a header, here is the result:
| a | 12 | 33 |
| c | 13 | 12 |
| x | 14 | 12 |
| y | 15 | 45 |
| z |  7 |  7 |

The correct result is a user error.

* several reference tables in pull mode
It is possible to join as many reference tables as wanted.

a small Spanish dictionary
#+name: spanish_colors
| color  | español  |
|--------+----------|
| yellow | amarillo |
| blue   | azul     |
| white  | blanco   |
| brown  | marrón   |
| orange | naranja  |
| black  | negro    |
| red    | rojo     |
| pink   | rosado   |
| green  | verde    |
| purple | violeta  |

a 12 bits color description
#+name: 12bits_colors
| color  | 12bits |
|--------+--------|
| black  | #000   |
| blue   | #00F   |
| green  | #0F0   |
| brown  | #880   |
| grey   | #888   |
| red    | #F00   |
| purple | #F0F   |
| orange | #F80   |
| pink   | #F8F   |
| yellow | #FF0   |
| white  | #FFF   |

a small Esperanto dictionary
#+name: esperanto_colors
| color  | esperanto |
|--------+-----------|
| white  | blanka    |
| blue   | blua      |
| brown  | bruna     |
| yellow | flava     |
| black  | nigra     |
| orange | oranĝa    |
| purple | purpura   |
| pink   | rozkolora |
| red    | ruĝa      |
| green  | verda     |

#+name: colors
| name   |
|--------|
| white  |
| red    |
| green  |
| yellow |
| blue   |
| pink   |

#+BEGIN: join :mas-table "colors" :mas-column "name" :full "mas" :ref-table "esperanto_colors" :ref-column "color" :ref-table "spanish_colors" :ref-column "color" :ref-table "12bits_colors" :ref-column "color"
| name   | esperanto | español  | 12bits |
|--------+-----------+----------+--------|
| white  | blanka    | blanco   | #FFF   |
| red    | ruĝa      | rojo     | #F00   |
| green  | verda     | verde    | #0F0   |
| yellow | flava     | amarillo | #FF0   |
| blue   | blua      | azul     | #00F   |
| pink   | rozkolora | rosado   | #F8F   |
#+END:

* several reference tables in push mode

#+orgtbl: send multi_color orgtbl-to-joined-table :mas-column name :ref-table "esperanto_colors" :ref-column "color" :ref-table "spanish_colors" :ref-column "color" :ref-table "12bits_colors" :ref-column "color"
| name   |
|--------|
| yellow |
| blue   |
| black  |
| orange |
| purple |
| brown  |
| pink   |

#+BEGIN RECEIVE ORGTBL multi_color
| name   | esperanto | español  | 12bits |
|--------+-----------+----------+--------|
| yellow | flava     | amarillo | #FF0   |
| blue   | blua      | azul     | #00F   |
| black  | nigra     | negro    | #000   |
| orange | oranĝa    | naranja  | #F80   |
| purple | purpura   | violeta  | #F0F   |
| brown  | bruna     | marrón   | #880   |
| pink   | rozkolora | rosado   | #F8F   |
#+END RECEIVE ORGTBL multi_color

* Input table is a Babel script

Note the =:colnames yes= parameter to output a header with label & value
column names.

The table resulting from the =ascript= script is computed on the fly, it
appears nowhere in the buffer.

#+name: ascript
#+begin_src elisp :colnames yes
'((type quantity)
  hline
  (egg 12.1)
  (bread 19.9)
  (eggplant 15.4))
#+end_src

#+BEGIN: join :mas-table "ascript" :ref-table "nut_with_header" :mas-column "type" :ref-column "type" :full "mas"
| type     | quantity | Carb | Fiber | Sugar | Protein |
|----------+----------+------+-------+-------+---------|
| egg      |     12.1 | 18.3 |     0 |  18.3 |    31.9 |
| bread    |     19.9 | 16.0 |   0.7 |   0.7 |     3.3 |
| eggplant |     15.4 |  8.6 |   2.5 |   3.2 |     0.8 |
| eggplant |     15.4 |  8.7 |   2.6 |   3.3 |     0.9 |
| eggplant |     15.4 |  8.5 |     ? |     ? |       ? |
#+END:

* CSV and JSON files

The master table is a JSON file containing a selection of large cities.
The reference table is a much larger CSV table referencing (almost) all countries in the World.
They are joined on the country column.

#+BEGIN: join :mas-table "geography-a.json:(json)" :ref-table "country.csv:(csv header)" :mas-column "$2" :ref-column "Country" :full "mas"
| Tokyo            | Japan          | 37131070 | 37173748 |  123425000 |  -655000 |   360582 | 1.23 | 93.3 |
| Delhi            | India          | 34598951 | 33741241 | 1460496000 | 13027300 |  2991887 | 1.95 | 36.9 |
| Shanghai         | China          | 30365228 | 29973570 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Dhaka            | Bangladesh     | 24561693 | 23958442 |  175745000 |  2114300 |   130913 | 2.13 | 42.4 |
| Cairo            | Egypt          | 23095986 | 22623336 |  117949000 |  1820200 |   985942 | 2.72 | 40.5 |
| Sao Paulo        | Brazil         | 23045227 | 22830606 |  213168000 |   817000 |  8444444 | 1.60 | 91.8 |
| Mexico City      | Mexico         | 22831373 | 22471468 |  132490000 |  1086700 |  1965122 | 1.88 | 87.6 |
| Beijing          | China          | 22559204 | 22155716 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Mumbai           | India          | 22012722 | 21690477 | 1460496000 | 13027300 |  2991887 | 1.95 | 36.9 |
| Osaka            | Japan          | 18990205 | 19040445 |  123425000 |  -655000 |   360582 | 1.23 | 93.3 |
| Chongqing        | China          | 18100872 | 17809422 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Karachi          | Pakistan       | 18059805 | 17637893 |  255349000 |  3949700 |   776185 | 3.53 | 34.6 |
| Kinshasa         | DR Congo       | 17815364 | 17025505 |  113171000 |  3557900 |  2273074 | 5.90 | 44.8 |
| Lagos            | Nigeria        | 17124998 | 16554804 |  238679000 |  4857400 |   912753 | 4.31 | 55.3 |
| Istanbul         | Turkey         | 16211581 | 16054896 |   87806000 |   213400 |   760713 | 1.61 | 76.4 |
| Kolkata          | India          | 15904385 | 15535352 | 1460496000 | 13027300 |  2991887 | 1.95 | 36.9 |
| Buenos Aires     | Argentina      | 15714124 | 15634092 |   46069000 |   155300 |  2747570 | 1.51 | 95.2 |
| Manila           | Philippines    | 15211511 | 14917612 |  116929000 |   949700 |   298788 | 1.89 | 49.2 |
| Guangzhou        | China          | 14870254 | 14634025 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Lahore           | Pakistan       | 14835678 | 14359466 |  255349000 |  3949700 |   776185 | 3.53 | 34.6 |
| Tianjin          | China          | 14729021 | 14417999 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Bangalore        | India          | 14387359 | 14059333 | 1460496000 | 13027300 |  2991887 | 1.95 | 36.9 |
| Rio de Janeiro   | Brazil         | 13880630 | 13774171 |  213168000 |   817000 |  8444444 | 1.60 | 91.8 |
| Shenzhen         | China          | 13501772 | 13330796 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Moscow           | Russia         | 12768223 | 12699759 |  143474000 |  -818700 | 16400780 | 1.48 | 75.1 |
| Chennai          | India          | 12353002 | 12009954 | 1460496000 | 13027300 |  2991887 | 1.95 | 36.9 |
| Bogota           | Colombia       | 11779275 | 11660428 |   53462000 |   538600 |  1097121 | 1.63 | 80.4 |
| Jakarta          | Indonesia      | 11628728 | 11478423 |  285916000 |  2230200 |  1815946 | 2.11 | 59.8 |
| Lima             | Peru           | 11529982 | 11388304 |   34507000 |   361600 |  1285354 | 1.96 | 81.0 |
| Bangkok          | Thailand       | 11415533 | 11195528 |   71614000 |   -48600 |   515245 | 1.20 | 53.3 |
| Paris            | France         | 11352823 | 11304387 |   66504000 |   101400 |   553012 | 1.65 | 83.2 |
| Hyderabad        | India          | 11307135 | 11046182 | 1460496000 | 13027300 |  2991887 | 1.95 | 36.9 |
| Nanjing          | China          | 10208049 |  9935614 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Luanda           | Angola         | 10049628 |  9648709 |   39009000 |  1151700 |  1251124 | 4.90 | 68.5 |
| Seoul            | South Korea    | 10059272 |  9991484 |   51891000 |   -50500 |    96644 | 0.75 | 83.1 |
| Chengdu          | China          | 10001659 |  9809118 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| London           | United Kingdom |  9818142 |  9723207 |   69618000 |   416400 |   243488 | 1.53 | 84.0 |
| Ho Chi Minh City | Vietnam        |  9798896 |  9541155 |  101523000 |   616900 |   309294 | 1.89 | 41.4 |
| Tehran           | Iran           |  9738111 |  9606808 |   92824000 |   841800 |  1614240 | 1.68 | 73.9 |
| Nagoya           | Japan          |  9544065 |  9544935 |  123425000 |  -655000 |   360582 | 1.23 | 93.3 |
| Xi-an            | China          |  9253706 |  9000317 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Ahmedabad        | India          |  9030745 |  8851159 | 1460496000 | 13027300 |  2991887 | 1.95 | 36.9 |
| Kuala Lumpur     | Malaysia       |  8980578 |  8832827 |   35830000 |   420000 |   324141 | 1.54 | 76.7 |
| Wuhan            | China          |  8951200 |  8834698 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Suzhou           | China          |  8588504 |  8351414 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Hangzhou         | China          |  8625267 |  8418349 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Surat            | India          |  8592860 |  8338575 | 1460496000 | 13027300 |  2991887 | 1.95 | 36.9 |
| Dar es Salaam    | Tanzania       |  8529744 |  8188494 |   70351000 |  1968700 |   889709 | 4.46 | 39.8 |
| Baghdad          | Iraq           |  8154140 |  7911328 |   47160000 |   987400 |   429484 | 3.17 | 72.6 |
| Shenyang         | China          |  7944044 |  7831541 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Riyadh           | Saudi Arabia   |  7964688 |  7848751 |   34501000 |   599400 |  2156035 | 2.28 | 92.4 |
| New York City    | United States  |  7966324 |  8100605 |  345969000 |  1856000 |  9035377 | 1.64 | 83.3 |
| Foshan           | China          |  7833467 |  7694081 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Dongguan         | China          |  7803482 |  7693276 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Hong Kong        | Hong Kong      |  7791531 |  7716372 |    7413000 |   -18800 |     1057 | 0.73 | 95.1 |
| Pune             | India          |  7498726 |  7369021 | 1460496000 | 13027300 |  2991887 | 1.95 | 36.9 |
| Haerbin          | China          |  7082652 |  6925340 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Santiago         | Chile          |  6973392 |  6953542 |   19918000 |    95000 |   744225 | 1.13 | 85.5 |
| Madrid           | Spain          |  6826620 |  6800842 |   48080000 |   -20700 |   505656 | 1.23 | 79.5 |
| Khartoum         | Sudan          |  6778168 |  6526345 |   51892000 |  1203800 |  1780621 | 4.21 | 35.4 |
| Toronto          | Canada         |  6513813 |  6450438 |   40292000 |   382900 |  9034818 | 1.32 | 80.0 |
| Johannesburg     | South Africa   |  6436807 |  6339743 |   64903000 |   744800 |  1218892 | 2.17 | 66.1 |
| Belo Horizonte   | Brazil         |  6360069 |  6281752 |  213168000 |   817000 |  8444444 | 1.60 | 91.8 |
| Dalian           | China          |  6360035 |  6239756 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Qingdao          | China          |  6242353 |  6098734 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Singapore        | Singapore      |  6167759 |  6115882 |    5856000 |    38000 |      694 | 0.95 | 97.7 |
| Zhengzhou        | China          |  6165031 |  5992273 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Ji nan Shandong  | China          |  6062368 |  5922823 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Abidjan          | Ivory Coast    |  6054358 |  5859424 |   32552000 |   779600 |   315141 | 4.21 | 49.3 |
| Addis Ababa      | Ethiopia       |  5961711 |  5681609 |  135372000 |  3414900 |   998796 | 3.84 | 22.5 |
| Yangon           | Myanmar        |  5829964 |  5706310 |   55035000 |   350400 |   657095 | 2.06 | 34.3 |
| Alexandria       | Egypt          |  5801580 |  5707049 |  117949000 |  1820200 |   985942 | 2.72 | 40.5 |
| Nairobi          | Kenya          |  5772121 |  5560131 |   57655000 |  1102600 |   571939 | 3.14 | 31.8 |
| Barcelona        | Spain          |  5751075 |  5730564 |   48080000 |   -20700 |   505656 | 1.23 | 79.5 |
| Chittagong       | Bangladesh     |  5635870 |  5533483 |  175745000 |  2114300 |   130913 | 2.13 | 42.4 |
| Hanoi            | Vietnam        |  5593577 |  5421696 |  101523000 |   616900 |   309294 | 1.89 | 41.4 |
| Saint Petersburg | Russia         |  5577807 |  5589909 |  143474000 |  -818700 | 16400780 | 1.48 | 75.1 |
| Guadalajara      | Mexico         |  5577341 |  5496809 |  132490000 |  1086700 |  1965122 | 1.88 | 87.6 |
| Ankara           | Turkey         |  5565915 |  5476444 |   87806000 |   213400 |   760713 | 1.61 | 76.4 |
| Fukuoka          | Japan          |  5452552 |  5499374 |  123425000 |  -655000 |   360582 | 1.23 | 93.3 |
| Melbourne        | Australia      |  5404124 |  5305432 |   27075000 |   263300 |  7679282 | 1.64 | 85.7 |
| Monterrey        | Mexico         |  5288432 |  5215757 |  132490000 |  1086700 |  1965122 | 1.88 | 87.6 |
| Sydney           | Australia      |  5258950 |  5188593 |   27075000 |   263300 |  7679282 | 1.64 | 85.7 |
| Urumqi           | China          |  5116895 |  5001934 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Changsha         | China          |  5112784 |  5047816 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Cape Town        | South Africa   |  5064396 |  4958870 |   64903000 |   744800 |  1218892 | 2.17 | 66.1 |
| Jiddah           | Saudi Arabia   |  5015645 |  4923708 |   34501000 |   599400 |  2156035 | 2.28 | 92.4 |
| Brasilia         | Brazil         |  4998660 |  4916085 |  213168000 |   817000 |  8444444 | 1.60 | 91.8 |
| Kunming          | China          |  4937047 |  4865282 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Changchun        | China          |  4900896 |  4796560 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Kabul            | Afghanistan    |  4862586 |  4712793 |   43961000 |  1200300 |   654688 | 4.64 | 26.8 |
| Yaounde          | Cameroon       |  4859198 |  4692347 |   29882000 |   756500 |   478301 | 4.18 | 59.4 |
| Hefei            | China          |  4822842 |  4735500 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Ningbo           | China          |  4780151 |  4659518 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Shantou          | China          |  4737079 |  4651827 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Kano             | Nigeria        |  4638799 |  4481282 |  238679000 |  4857400 |   912753 | 4.31 | 55.3 |
| Tel Aviv         | Israel         |  4577871 |  4500492 |    9545000 |   130400 |    21879 | 2.74 | 92.1 |
| New Taipei       | Taiwan         |  4570576 |  4522439 |   23110000 |  -100900 |    35234 | 0.86 | 83.2 |
| Shijiazhuang     | China          |  4527329 |  4462103 | 1410526000 | -3221000 |  9445627 | 1.02 | 67.6 |
| Jaipur           | India          |  4406280 |  4321166 | 1460496000 | 13027300 |  2991887 | 1.95 | 36.9 |
#+END:
